# AD-SDLC Workflow Configuration
# Agent-Driven Software Development Lifecycle System

version: "1.0.0"
name: "AD-SDLC Workflow"

# =============================================================================
# Global Settings
# =============================================================================
global:
  project_root: "${PWD}"
  scratchpad_dir: ".ad-sdlc/scratchpad"
  output_docs_dir: "docs"
  log_level: "INFO"  # DEBUG, INFO, WARN, ERROR

  # Human-in-the-loop approval gates
  approval_gates:
    after_collection: true
    after_prd: true
    after_srs: true
    after_github_repo_setup: true
    after_sds: true
    after_issues: true
    before_merge: false  # Auto-merge if all checks pass

  # Retry policy for agents
  retry_policy:
    max_attempts: 3
    backoff: "exponential"
    base_delay_seconds: 5
    max_delay_seconds: 60

  # Timeout settings
  timeouts:
    document_generation: 300  # 5 minutes
    issue_creation: 60
    implementation: 1800  # 30 minutes
    pr_review: 300

# =============================================================================
# Pipeline Mode Selection
# =============================================================================
# Mode is determined by mode-detector agent or can be overridden by user
# See mode-detection.yaml for detection rules and thresholds

# =============================================================================
# Pipeline Stages by Mode
# =============================================================================
pipeline:
  # Default mode (can be overridden by user or auto-detected)
  default_mode: "greenfield"

  modes:
    # =========================================================================
    # Greenfield Mode - Full document generation pipeline for new projects
    # =========================================================================
    greenfield:
      description: "Full document generation pipeline for new projects"
      stages:
        - name: "collection"
          agent: "collector"
          description: "Collect and structure user requirements"
          inputs:
            - type: "user_message"
            - type: "files"
            - type: "urls"
          outputs:
            - "${scratchpad_dir}/info/${project_id}/collected_info.yaml"
          next: "prd_generation"
          approval_required: true

        - name: "prd_generation"
          agent: "prd-writer"
          description: "Generate PRD from collected information"
          inputs:
            - "${scratchpad_dir}/info/${project_id}/collected_info.yaml"
          outputs:
            - "${scratchpad_dir}/documents/${project_id}/prd.md"
            - "${output_docs_dir}/prd/PRD-${project_id}.md"
          next: "srs_generation"
          approval_required: true

        - name: "srs_generation"
          agent: "srs-writer"
          description: "Generate SRS from PRD"
          inputs:
            - "${scratchpad_dir}/documents/${project_id}/prd.md"
          outputs:
            - "${scratchpad_dir}/documents/${project_id}/srs.md"
            - "${output_docs_dir}/srs/SRS-${project_id}.md"
          next: "github_repo_setup"
          approval_required: true

        - name: "github_repo_setup"
          agent: "github-repo-setup"
          description: "Create and initialize public GitHub repository"
          inputs:
            - "${scratchpad_dir}/documents/${project_id}/prd.md"
            - "${scratchpad_dir}/documents/${project_id}/srs.md"
          outputs:
            - "${scratchpad_dir}/repo/${project_id}/github_repo.yaml"
          next: "sds_generation"
          approval_required: true

        - name: "sds_generation"
          agent: "sds-writer"
          description: "Generate SDS from SRS"
          inputs:
            - "${scratchpad_dir}/documents/${project_id}/srs.md"
          outputs:
            - "${scratchpad_dir}/documents/${project_id}/sds.md"
            - "${output_docs_dir}/sds/SDS-${project_id}.md"
          next: "issue_generation"
          approval_required: true

        - name: "issue_generation"
          agent: "issue-generator"
          description: "Generate GitHub issues from SDS"
          inputs:
            - "${scratchpad_dir}/documents/${project_id}/sds.md"
          outputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          next: "orchestration"
          approval_required: true

        - name: "orchestration"
          agent: "controller"
          description: "Orchestrate work distribution"
          inputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/controller_state.yaml"
            - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
          next: "implementation"
          approval_required: false

        - name: "implementation"
          agent: "worker"
          description: "Implement assigned issues"
          parallel: true
          max_parallel: 5
          inputs:
            - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
            - "src/**/*"
          next: "review"
          approval_required: false

        - name: "review"
          agent: "pr-reviewer"
          description: "Create and review PRs"
          inputs:
            - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/reviews/*.yaml"
          next: null  # End of pipeline
          approval_required: false

    # =========================================================================
    # Enhancement Mode - Incremental update pipeline for existing projects
    # =========================================================================
    enhancement:
      description: "Incremental update pipeline for existing projects"
      stages:
        - name: "analysis_parallel"
          description: "Parallel analysis of existing documents and codebase"
          parallel: true
          substages:
            - name: "document_reading"
              agent: "document-reader"
              description: "Parse existing PRD/SRS/SDS documents"
              inputs:
                - type: "existing_documents"
                - "${output_docs_dir}/prd/*.md"
                - "${output_docs_dir}/srs/*.md"
                - "${output_docs_dir}/sds/*.md"
              outputs:
                - "${scratchpad_dir}/current_state/${project_id}/current_state.yaml"
              approval_required: false

            - name: "codebase_analysis"
              agent: "codebase-analyzer"
              description: "Analyze existing codebase structure"
              inputs:
                - type: "source_code"
                - "src/**/*"
                - "package.json"
                - "tsconfig.json"
              outputs:
                - "${scratchpad_dir}/analysis/${project_id}/architecture_overview.yaml"
                - "${scratchpad_dir}/analysis/${project_id}/dependency_graph.json"
              approval_required: false
          next: "impact_analysis"

        - name: "impact_analysis"
          agent: "impact-analyzer"
          description: "Analyze change impact on existing system"
          inputs:
            - type: "user_message"
            - "${scratchpad_dir}/current_state/${project_id}/current_state.yaml"
            - "${scratchpad_dir}/analysis/${project_id}/architecture_overview.yaml"
            - "${scratchpad_dir}/analysis/${project_id}/dependency_graph.json"
          outputs:
            - "${scratchpad_dir}/impact/${project_id}/impact_report.yaml"
          next: "document_update"
          approval_required: true  # Human review of impact analysis

        - name: "document_update"
          description: "Sequential document updates (PRD → SRS → SDS)"
          substages:
            - name: "prd_update"
              agent: "prd-updater"
              description: "Incrementally update PRD"
              inputs:
                - "${output_docs_dir}/prd/*.md"
                - "${scratchpad_dir}/impact/${project_id}/impact_report.yaml"
              outputs:
                - "${scratchpad_dir}/documents/${project_id}/prd_update_result.yaml"
                - "${output_docs_dir}/prd/PRD-${project_id}.md"
                - "${output_docs_dir}/prd/prd_changelog.md"
              next: "srs_update"
              approval_required: true

            - name: "srs_update"
              agent: "srs-updater"
              description: "Incrementally update SRS"
              inputs:
                - "${output_docs_dir}/srs/*.md"
                - "${scratchpad_dir}/documents/${project_id}/prd_update_result.yaml"
              outputs:
                - "${scratchpad_dir}/documents/${project_id}/srs_update_result.yaml"
                - "${output_docs_dir}/srs/SRS-${project_id}.md"
                - "${output_docs_dir}/srs/srs_changelog.md"
              next: "sds_update"
              approval_required: true

            - name: "sds_update"
              agent: "sds-updater"
              description: "Incrementally update SDS"
              inputs:
                - "${output_docs_dir}/sds/*.md"
                - "${scratchpad_dir}/documents/${project_id}/srs_update_result.yaml"
              outputs:
                - "${scratchpad_dir}/documents/${project_id}/sds_update_result.yaml"
                - "${output_docs_dir}/sds/SDS-${project_id}.md"
                - "${output_docs_dir}/sds/sds_changelog.md"
              approval_required: true
          next: "issue_generation"

        - name: "issue_generation"
          agent: "issue-generator"
          description: "Generate issues from updated SDS and impact report"
          inputs:
            - "${scratchpad_dir}/documents/${project_id}/sds_update_result.yaml"
            - "${scratchpad_dir}/impact/${project_id}/impact_report.yaml"
          outputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          next: "orchestration"
          approval_required: true

        - name: "orchestration"
          agent: "controller"
          description: "Orchestrate work distribution"
          inputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/controller_state.yaml"
            - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
          next: "parallel_execution"
          approval_required: false

        - name: "parallel_execution"
          description: "Parallel execution of implementation and regression testing"
          parallel: true
          substages:
            - name: "implementation"
              agent: "worker"
              description: "Implement assigned issues"
              parallel: true
              max_parallel: 5
              inputs:
                - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
              outputs:
                - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
                - "src/**/*"
              approval_required: false

            - name: "regression_testing"
              agent: "regression-tester"
              description: "Run regression tests for affected areas"
              inputs:
                - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
                - "${scratchpad_dir}/analysis/${project_id}/dependency_graph.json"
              outputs:
                - "${scratchpad_dir}/progress/${project_id}/regression_report.yaml"
              approval_required: false
          next: "review"

        - name: "review"
          agent: "pr-reviewer"
          description: "Create and review PRs with regression report"
          inputs:
            - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
            - "${scratchpad_dir}/progress/${project_id}/regression_report.yaml"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/reviews/*.yaml"
          next: null  # End of pipeline
          approval_required: false

    # =========================================================================
    # Import Mode - Start from existing GitHub issues
    # =========================================================================
    import:
      description: "Import existing GitHub issues and start execution pipeline"
      stages:
        - name: "issue_reading"
          agent: "issue-reader"
          description: "Import existing GitHub issues to AD-SDLC format"
          inputs:
            - type: "github_issues"
            - type: "filter_criteria"
          outputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          next: "orchestration"
          approval_required: true

        - name: "orchestration"
          agent: "controller"
          description: "Orchestrate work distribution from imported issues"
          inputs:
            - "${scratchpad_dir}/issues/${project_id}/issue_list.json"
            - "${scratchpad_dir}/issues/${project_id}/dependency_graph.json"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/controller_state.yaml"
            - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
          next: "implementation"
          approval_required: false

        - name: "implementation"
          agent: "worker"
          description: "Implement assigned issues"
          parallel: true
          max_parallel: 5
          inputs:
            - "${scratchpad_dir}/progress/${project_id}/work_orders/*.yaml"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
            - "src/**/*"
          next: "review"
          approval_required: false

        - name: "review"
          agent: "pr-reviewer"
          description: "Create and review PRs"
          inputs:
            - "${scratchpad_dir}/progress/${project_id}/results/*.yaml"
          outputs:
            - "${scratchpad_dir}/progress/${project_id}/reviews/*.yaml"
          next: null  # End of pipeline
          approval_required: false

  # Legacy compatibility: stages array for backward compatibility
  # When no mode is specified, this defaults to greenfield stages
  stages: []  # Use modes.greenfield.stages, modes.enhancement.stages, or modes.import.stages

# =============================================================================
# Agent Configurations
# =============================================================================
agents:
  collector:
    model: "sonnet"
    tools:
      - Read
      - WebFetch
      - WebSearch
      - Grep
      - Glob
      - Write
    max_questions: 5  # Max clarifying questions before proceeding

  prd-writer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    template: ".ad-sdlc/templates/prd-template.md"

  srs-writer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    template: ".ad-sdlc/templates/srs-template.md"

  github-repo-setup:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
      - Bash
    repository:
      visibility: "public"
      default_branch: "main"
      default_license: "MIT"
    github:
      require_auth: true
      add_topics: true

  sds-writer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    template: ".ad-sdlc/templates/sds-template.md"

  issue-generator:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Bash
      - Glob
      - Grep
    template: ".ad-sdlc/templates/issue-template.md"
    github:
      labels_prefix: "ad-sdlc"
      auto_assign: false

  issue-reader:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Bash
      - Glob
      - Grep
    github:
      default_state: "open"
      max_issues: 500
    priority_mapping:
      critical: "P0"
      priority-p0: "P0"
      high: "P1"
      priority-p1: "P1"
      medium: "P2"
      priority-p2: "P2"
      low: "P3"
      priority-p3: "P3"
    effort_mapping:
      "size:XS": 2
      "size:S": 4
      "size:M": 6
      "size:L": 12
      "size:XL": 20

  controller:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Bash
      - Glob
      - Grep
    scheduling:
      algorithm: "priority_dependency"  # priority_only, dependency_only, priority_dependency
      max_workers: 5
      check_interval_seconds: 30

  worker:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Bash
      - Glob
      - Grep
    coding:
      language: "typescript"  # Adjust per project
      test_framework: "jest"
      lint_command: "npm run lint"
      test_command: "npm test"
      build_command: "npm run build"
    verification:
      run_tests: true
      run_lint: true
      run_build: true
      coverage_threshold: 80

  pr-reviewer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Bash
      - Glob
      - Grep
    review:
      auto_merge: false
      require_all_checks: true
      coverage_threshold: 80
      max_complexity: 10
    github:
      merge_strategy: "squash"  # merge, squash, rebase
      delete_branch_after_merge: true

  # ---------------------------------------------------------------------------
  # Enhancement Pipeline Agent Configurations
  # ---------------------------------------------------------------------------
  document-reader:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Glob
      - Grep
    parsing:
      supported_formats:
        - markdown
        - yaml
      extract_ids: true
      build_traceability: true

  codebase-analyzer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Glob
      - Grep
      - Bash
    analysis:
      languages:
        - typescript
        - javascript
        - python
      detect_patterns: true
      generate_metrics: true
      max_depth: 10

  impact-analyzer:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Glob
      - Grep
    risk_scoring:
      enabled: true
      factors:
        - code_complexity
        - dependency_count
        - test_coverage
        - change_scope

  prd-updater:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    update_modes:
      - add_requirement
      - modify_requirement
      - deprecate_requirement
      - extend_scope
    version_management:
      auto_increment: true
      generate_changelog: true

  srs-updater:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    update_modes:
      - add_feature
      - add_use_case
      - modify_feature
      - update_interface
      - update_traceability
    traceability:
      maintain_prd_links: true
      auto_update_matrix: true

  sds-updater:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Edit
      - Glob
      - Grep
    update_modes:
      - add_component
      - add_api
      - modify_component
      - update_data_model
      - update_architecture
    traceability:
      maintain_srs_links: true
      auto_update_matrix: true

  regression-tester:
    model: "sonnet"
    tools:
      - Read
      - Write
      - Glob
      - Grep
      - Bash
    testing:
      run_affected_tests: true
      coverage_analysis: true
      compatibility_check: true
    thresholds:
      min_coverage: 80
      max_regression_risk: "medium"

# =============================================================================
# Quality Gates
# =============================================================================
quality_gates:
  document_quality:
    prd:
      required_sections:
        - executive_summary
        - problem_statement
        - functional_requirements
        - non_functional_requirements
      min_requirements: 3

    srs:
      required_sections:
        - system_features
        - use_cases
        - traceability_matrix
      min_features: 1
      min_use_cases_per_feature: 1

    sds:
      required_sections:
        - system_architecture
        - component_design
        - api_specification
      min_components: 1

  code_quality:
    coverage_threshold: 80
    max_complexity: 10
    max_line_length: 100
    no_todos_in_code: false
    no_console_logs: true

  security:
    no_hardcoded_secrets: true
    require_input_validation: true
    require_authentication: true

# =============================================================================
# Notifications
# =============================================================================
notifications:
  enabled: false  # Set to true to enable
  channels:
    - type: "slack"
      webhook: "${SLACK_WEBHOOK_URL}"
      events:
        - stage_complete
        - approval_required
        - error

    - type: "email"
      recipients:
        - "${NOTIFICATION_EMAIL}"
      events:
        - approval_required
        - pipeline_complete

  templates:
    stage_complete: "Stage '${stage}' completed successfully."
    approval_required: "Approval required for stage '${stage}'. Review: ${url}"
    error: "Error in stage '${stage}': ${error_message}"

# =============================================================================
# GitHub Integration
# =============================================================================
github:
  repo: "${GITHUB_REPO}"  # owner/repo format
  default_branch: "main"
  issue_labels:
    - "ad-sdlc:auto-generated"
  pr_labels:
    - "ad-sdlc:auto-generated"
  milestone_prefix: "AD-SDLC"

# =============================================================================
# Logging & Monitoring
# =============================================================================
logging:
  level: "INFO"
  format: "json"
  output:
    - type: "file"
      path: ".ad-sdlc/logs/ad-sdlc.log"
      rotate: true
      max_size: "10MB"
      max_files: 5

    - type: "console"
      format: "pretty"

  include:
    - agent_name
    - stage
    - timestamp
    - duration
    - status

monitoring:
  enabled: false
  metrics:
    - stage_duration
    - agent_invocations
    - success_rate
    - issues_created
    - prs_merged
